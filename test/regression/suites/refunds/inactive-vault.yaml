{{ template "default-state.yaml" }}
---
type: state
genesis:
  app_state:
    bank:
      balances:
        - address: {{ addr_module_asgard }}
          coins:
            - amount: "100000000000"
              denom: rune
    thorchain:
      liquidity_providers:
        - asset: BTC.BTC
          asset_address: {{ addr_btc_cat }}
          asset_deposit_value: "100000000"
          last_add_height: "1"
          pending_asset: "0"
          pending_rune: "0"
          rune_address: {{ addr_thor_cat }}
          rune_deposit_value: "100000000000"
          units: "100000000000"
      pools:
        - LP_units: "100000000000"
          asset: BTC.BTC
          balance_asset: "100000000"
          balance_rune: "100000000000"
          decimals: "8"
          pending_inbound_asset: "0"
          pending_inbound_rune: "0"
          status: Available
          synth_units: "0"
      network_fees:
        - chain: BTC
          transaction_fee_rate: "7"
          transaction_size: "1000"
      vaults:
        - block_height: "0"
          chains:
            - THOR
            - BTC
            - LTC
            - BCH
            - BNB
            - ETH
            - DOGE
            - TERRA
            - AVAX
            - GAIA
          coins:
            - amount: "100000000"
              asset: BTC.BTC
              decimals: "8"
          inbound_tx_count: "1"
          membership:
            - tthorpub1addwnpepqfshsq2y6ejy2ysxmq4gj8n8mzuzyulk9wh4n946jv5w2vpwdn2yuyp6sp4
          pub_key: tthorpub1addwnpepqfshsq2y6ejy2ysxmq4gj8n8mzuzyulk9wh4n946jv5w2vpwdn2yuyp6sp4
          status: ActiveVault
          type: AsgardVault
        - block_height: "0"
          chains:
            - THOR
            - BTC
            - LTC
            - BCH
            - BNB
            - ETH
            - DOGE
            - TERRA
            - AVAX
            - GAIA
          coins: [] # Empty Coins at the start
          inbound_tx_count: "1"
          membership:
            - {{ pubkey_fish }}
          pub_key: {{ pubkey_fish }}
          status: InactiveVault
          type: AsgardVault
---
type: create-blocks
count: 1
---
# Confirm ActiveVault states.
type: check
endpoint: http://localhost:1317/thorchain/vaults/asgard
asserts:
  - .| length == 1
  - .[0].status == "ActiveVault"
  - .[0].coins|length == 1
  - .[0].coins[0].amount == "${ACTIVE_VAULT_AMOUNT=100000000}"
---
# Confirm InactiveVault state.
type: check
endpoint: http://localhost:1317/thorchain/vault/{{ pubkey_fish }}
asserts:
  - .status == "InactiveVault"
  - .coins | length == 0 # No coins
---
# Confirm pool state.
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC
asserts:
  - .balance_asset == "${ACTIVE_VAULT_AMOUNT}"
  - .balance_rune == "${START_BALANCE_RUNE=100001087646}"
---
# Confirm that no outbounds.
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 0
---
########################################################################################
type: tx-observed-in
signer: {{ addr_thor_dog }}
txs:
  - tx:
      id: "${INBOUND_TXID={{ observe_txid 1 }}}"
      chain: BTC
      from_address: ${IN_FROM_ADDRESS={{ addr_btc_fox }}}
      to_address: ${IN_TO_ADDRESS={{ addr_btc_fish }}} # The inactive vault
      coins:
        - amount: "${INBOUND_AMOUNT=100000}"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "${GAS_COST=7000}"
          asset: "BTC.BTC"
      memo: "ADD:BTC.BTC"
    block_height: 7
    finalise_height: 7
    observed_pub_key: ${OBSERVED_PUB_KEY={{ pubkey_fish }}} # InactiveVault
---
type: create-blocks
count: 1
---
# Confirm unchanged ActiveVault state.
type: check
endpoint: http://localhost:1317/thorchain/vaults/asgard
asserts:
  - .| length == 1
  - .[0].status == "ActiveVault"
  - .[0].coins|length == 1
  - .[0].coins[0].amount == "${ACTIVE_VAULT_AMOUNT}"
---
# Check changed InactiveVault state.
type: check
endpoint: http://localhost:1317/thorchain/vault/{{ pubkey_fish }}
asserts:
  - .status == "InactiveVault"
  - .coins | length == 1 # Coin received
  - .coins[0].amount == "${INBOUND_AMOUNT}"
---
type: check
endpoint: http://localhost:1317/thorchain/block
asserts:
  - .| [..|select(.type? == "refund")] | length == 1
  - .|..|select(.type? == "refund") | .reason | contains("inactive vault")
  - .| [..|select(.type? == "fee")] | length == 0
---
# Check whether pool balance_asset is unchanged and balance_rune is no lower.
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC
asserts:
  - .balance_asset == "${ACTIVE_VAULT_AMOUNT}"
  - .balance_rune | tonumber > ${START_BALANCE_RUNE} # Higher from block rewards
---
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 1
  - .[0].memo | contains("REFUND:")
  - .[0].max_gas | length == 1
  - .[0] | .coin.asset == .max_gas[0].asset
  - .[0] | (.coin.amount|tonumber) + (.max_gas[0].amount|tonumber) == ${INBOUND_AMOUNT}
  # Prepare the observed txout amount:
  - . | ${INBOUND_AMOUNT} - ${GAS_COST} == ${OUT_AMOUNT=93000}
---
########################################################################################
type: tx-observed-out
signer: {{ addr_thor_dog }}
txs:
  - tx:
      id: "{{ observe_txid 2 }}"
      chain: BTC
      from_address: ${IN_TO_ADDRESS}
      to_address: ${IN_FROM_ADDRESS}
      coins:
        - amount: "${OUT_AMOUNT}"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "${GAS_COST}"
          asset: "BTC.BTC"
      memo: "REFUND:${INBOUND_TXID}"
    block_height: 4
    finalise_height: 4
    observed_pub_key: ${OBSERVED_PUB_KEY}
---
type: create-blocks
count: 1
---
# Confirm that the txout fulfilled the queued TxOutItem.
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 0
---
# Confirm unchanged ActiveVault state.
type: check
endpoint: http://localhost:1317/thorchain/vaults/asgard
asserts:
  - .| length == 1
  - .[0].status == "ActiveVault"
  - .[0].coins|length == 1
  - .[0].coins[0].amount == "${ACTIVE_VAULT_AMOUNT}"
---
# Check emptied InactiveVault state.
type: check
endpoint: http://localhost:1317/thorchain/vault/{{ pubkey_fish }}
asserts:
  - .status == "InactiveVault"
  - .coins | length == 1
  - .coins[0].amount == "0"
---
# Check the pool balances.
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC
asserts:
  - .balance_asset == "${ACTIVE_VAULT_AMOUNT}"
  - .balance_rune | tonumber > ${START_BALANCE_RUNE}

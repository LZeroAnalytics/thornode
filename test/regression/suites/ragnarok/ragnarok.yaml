{{ template "default-state.yaml" }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/thorchain/pools
asserts:
  - .|length == 0
---
type: tx-mimir
key: "RagnarokProcessNumOfLPPerIteration"
value: 2
signer: {{ addr_thor_dog }}
sequence: 0
---
type: tx-mimir
key: "FundMigrationInterval"
value: 1
signer: {{ addr_thor_dog }}
sequence: 1
---
type: tx-network-fee
signer: {{ addr_thor_dog }}
block_height: 1
chain: BTC
transaction_size: 1000
transaction_rate: 10
sequence: 2
---
type: create-blocks
count: 1
---
########################################################################################
# create btc pool with 2 liquidity providers
########################################################################################
type: tx-observed-in
signer: {{ addr_thor_dog }}
txs:
  - tx:
      id: "{{ observe_txid 1 }}"
      chain: BTC
      from_address: {{ addr_btc_cat }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "100000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "+:BTC.BTC:{{ addr_thor_cat }}"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
  - tx:
      id: "{{ observe_txid 2 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "100000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "+:BTC.BTC:{{ addr_thor_fox }}"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
---
type: tx-deposit
signer: {{ addr_thor_cat }}
coins:
  - amount: "200000000"
    asset: "rune"
memo: "+:BTC.BTC:{{ addr_btc_cat }}"
---
type: tx-deposit
signer: {{ addr_thor_fox }}
coins:
  - amount: "200000000"
    asset: "rune"
memo: "+:BTC.BTC:{{ addr_btc_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/thorchain/tx/{{ observe_txid 1 }}
asserts:
  - .observed_tx.status == "done"
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/liquidity_providers
asserts:
  - .|length == 2
---
type: check
endpoint: http://localhost:1317/thorchain/pools
asserts:
  - .|length == 1
  - .[0].LP_units == "400000000"
  - .[0].pending_inbound_asset == "0"
  - .[0].pending_inbound_rune == "0"
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/liquidity_providers
asserts:
  - .|length == 2
  - .[0].units == "200000000"
  - .[1].units == "200000000"
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/savers
asserts:
  - .|length == 0
---
########################################################################################
# add 3 savers
########################################################################################
type: tx-observed-in
signer: {{ addr_thor_dog }}
txs:
  - tx:
      id: "{{ observe_txid 3 }}"
      chain: BTC
      from_address: {{ addr_btc_cat }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "+:BTC/BTC"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
  - tx:
      id: "{{ observe_txid 4 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "+:BTC/BTC"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
  - tx:
      id: "{{ observe_txid 5 }}"
      chain: BTC
      from_address: {{ addr_btc_pig }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "+:BTC/BTC"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/savers
asserts:
  - .|length == 3
---
########################################################################################
# stream to one synth holder
########################################################################################
type: tx-deposit
signer: {{ addr_thor_fox }}
coins:
  - amount: "100000000"
    asset: "rune"
memo: "=:BTC/BTC:{{ addr_thor_fox }}:0/1/2"
---
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_thor_fox }}
asserts:
  - .balances|length == 1
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/thorchain/swaps/streaming
asserts:
  - .|length == 1
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/thorchain/swaps/streaming
asserts:
  - .|length == 0
---
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_thor_fox }}
asserts:
  - .balances|length == 2
  - .balances[]|select(.denom=="btc/btc")|.amount|tonumber == 47214625
---
########################################################################################
# ragnarok the pool
########################################################################################
type: tx-mimir
key: "RAGNAROK-BTC-BTC"
value: 1
signer: {{ addr_thor_dog }}
---
type: create-blocks
count: 1
---
########################################################################################
# first block should eject two savers
########################################################################################
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/savers
asserts:
  - .|length == 1
---
# savers eject to the swap queue for synth -> L1 before outbound
type: check
endpoint: http://localhost:1317/thorchain/queue/swap
asserts:
  - .|length == 2
---
########################################################################################
# swap to L1 and streaming synth exit should not be allowed on ragnarok pool
########################################################################################
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_thor_cat }}
asserts:
  - .balances[]|select(.denom=="rune")|.amount|tonumber == ${CAT_BALANCE=2499798000000}
---
type: tx-deposit
signer: {{ addr_thor_cat }}
coins:
  - amount: "200000000"
    asset: "rune"
memo: "=:BTC.BTC:{{ addr_btc_cat }}"
---
type: tx-deposit
signer: {{ addr_thor_fox }}
coins:
  - amount: "47214625"
    asset: "btc/btc"
memo: "=:BTC.BTC:{{ addr_btc_fox }}:0/1/0"
---
type: create-blocks
count: 1
---
# cat account lost gas
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_thor_cat }}
asserts:
  - .balances[]|select(.denom=="rune")|.amount|tonumber == ${CAT_BALANCE}-4000000
---
# cat account had refund event
type: check
endpoint: http://localhost:1317/thorchain/block
asserts:
  - .txs[0].result.events[]|select(.type=="refund")|.reason=="trading halted"
  - .end_block_events[]|select(.type=="refund")|.reason="streaming swaps disabled on ragnarok asset BTC/BTC"
---
########################################################################################
# second block should eject last saver and create outbounds for the first 2
########################################################################################
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/savers
asserts:
  - .|length == 0
---
type: check
endpoint: http://localhost:1317/thorchain/queue/swap
asserts:
  - .|length == 1
---
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 2
---
# lps should be untouched
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/liquidity_providers
asserts:
  - .|length == 2
  - .[0].units == "200000000"
  - .[1].units == "200000000"
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC
asserts:
  - .status == "Available"
---
# set to 1 to see the pool status change Available -> Staged -> Suspended
type: tx-mimir
key: "RagnarokProcessNumOfLPPerIteration"
value: 1
signer: {{ addr_thor_dog }}
---
########################################################################################
# non streaming synth exit is allowed
########################################################################################
type: tx-deposit
signer: {{ addr_thor_fox }}
coins:
  - amount: "46301122"
    asset: "btc/btc"
memo: "=:BTC.BTC:{{ addr_btc_fox }}"
---
########################################################################################
# third block should create last saver outbound, stage the pool, and eject first lp
########################################################################################
type: create-blocks
count: 1
---
# non streaming exit should have processed
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_thor_fox }}
asserts:
  - .balances|length == 1
---
type: check
endpoint: http://localhost:1317/thorchain/queue/swap
asserts:
  - .|length == 0
---
# all saver outbounds plus the first LP
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 5
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC/liquidity_providers
asserts:
  - .|length == 1
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC
asserts:
  - .status == "Staged"
---
# observe saver outbounds
type: tx-observed-out
signer: {{ addr_thor_dog }}
txs:
  - tx:
      id: "{{ observe_txid 6 }}"
      chain: BTC
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_pig }}
      coins:
        - amount: "8836439"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "15000"
          asset: "BTC.BTC"
      memo: "OUT:08225BF81303B3A86025AE667C66FF37248B5FDB25FF407CD9EF26F462CFFFDE"
    block_height: 2
    finalise_height: 2
    observed_pub_key: {{ pubkey_dog }}
  - tx:
      id: "{{ observe_txid 7 }}"
      chain: BTC
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_fox }}
      coins:
        - amount: "8790793"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "15000"
          asset: "BTC.BTC"
      memo: "OUT:AA60EAE5F458E2792021ED907F458AF263566DF3AD47235D2CE8E19730BD5E8E"
    block_height: 2
    finalise_height: 2
    observed_pub_key: {{ pubkey_dog }}
  - tx:
      id: "{{ observe_txid 8 }}"
      chain: BTC
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_cat }}
      coins:
        - amount: "8622955"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "15000"
          asset: "BTC.BTC"
      memo: "OUT:29F6955711136F1C53BDF8ED9103B45E0346F95D632187EC934989545FE5CF74"
    block_height: 2
    finalise_height: 2
    observed_pub_key: {{ pubkey_dog }}
  - tx:
      id: "{{ observe_txid 9 }}"
      chain: BTC
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_fox }}
      coins:
        - amount: "30952865"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "15000"
          asset: "BTC.BTC"
      memo: "OUT:D784DDCCD906333B48C8493B836BFB5CD9DA805549A9B7927548C33A43E863D3"
    block_height: 2
    finalise_height: 2
    observed_pub_key: {{ pubkey_dog }}
---
########################################################################################
# fourth block should eject last lp, but it will fail with insufficient funds
########################################################################################
type: create-blocks
count: 1
skip_invariants: true # last withdraw failed, but LP was removed
---
# just the one lp outbound remains
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 1
---
# observe lp outbound
type: tx-observed-out
signer: {{ addr_thor_dog }}
txs:
  - tx:
      id: "{{ observe_txid 10 }}"
      chain: BTC
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_fox }}
      coins:
        - amount: "86383474"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "15000"
          asset: "BTC.BTC"
      memo: "RAGNAROK:9"
    block_height: 3
    finalise_height: 3
    observed_pub_key: {{ pubkey_dog }}
---
########################################################################################
# fifth block should mark the pool suspended
########################################################################################
type: create-blocks
count: 1
skip_invariants: true # last withdraw failed, but LP was removed
---
type: check
endpoint: http://localhost:1317/thorchain/pool/BTC.BTC
asserts:
  - .status == "Suspended"
---
type: check
endpoint: http://localhost:1317/thorchain/queue/outbound
asserts:
  - .|length == 0
